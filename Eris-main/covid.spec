t1 := firstadminlevels(country='ES');
t2 := (t1){id->region};
t3 := ((t2)[region SUM]);
t4 := ((eurostats_perregion UNION eurostats_perregion_estimated){deaths->current});
t5 := (t3 JOIN t4);
t6 := (weeks{id->week})(week = '2020W52');
t7 := (t5 JOIN t6);
t8 := ((eurostats_perregion UNION eurostats_perregion_estimated){counter := 1});
t9 := (t3 JOIN t8);
t10:= ((weeks{id->week})(yearofweek>'2018' AND yearofweek<'2020'));
t11:= (t9 JOIN t10);
t12:= (t11[weekofyear, region SUM deaths, counter]);
t13:= (t12{average:=deaths/counter});
t14:= (t7 JOIN t13);
t15:= (t14{negavg:=-1*average});
t16:= (t15{surplus:=current+negavg});
t17:= (t16[surplus]);
t18:=(eurostats_percountry_perweek UNION eurostats_percountry_perweek_estimated);
t19:=(t18{deaths->current});
t20:=(t19(country='ES'));
t21:=( t20 JOIN t6);
t22:=((t18{counter:=1})(country='ES'));
t23:=(t22 JOIN t10);
t24:=(t23[weekofyear, country SUM deaths, counter]);
t25:=(t24{average:=deaths/counter});
t26:=(t21 JOIN t25);
t27:=(t26{negavg:=-1*average});
t28:=(t27{surplus:=current+negavg});
t29:=(t28[surplus]);
t30:=((weeks{id->week})(yearofweek>'2014' AND yearofweek<'2020' AND weekofyear>'03' and weekofyear<'46'));
t31:=(t18 JOIN t30);
t32:=(t31[country, year SUM deaths]);
t33:=((t32{counter:=1})[country SUM deaths, counter]);
t34:=(t33{average:=deaths/counter});
t35:=(t18 JOIN t6);
t36:=(t35[country SUM deaths]);
t37:=(t36{deaths->current});
t38:=(t37 JOIN  t34);
t39:=(t38{negavg:=-1*average});
t40:=(t39{surplus:=current+negavg})[surplus];
t41:=(((jhu_percountry(country='ES'))JOIN((dates{id->date}) JOIN (weeks{id->week})))[country, weekofyear SUM deaths]){deaths->surplus};
t42:=(((((t17 JOIN(firstadminlevels{id->region}))[country, weekofyear SUM surplus])DUNION[source1](t29 [country, weekofyear SUM surplus]))[COAL source1])DUNION[source2] t41)[COAL source2]
